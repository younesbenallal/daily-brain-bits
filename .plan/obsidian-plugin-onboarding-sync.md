# Plan

Move Obsidian onboarding + sync initiation into the Obsidian plugin settings (token + glob + sync now), while keeping the DBB web onboarding as a lightweight “install + connect + wait” flow. Make onboarding completion deterministic by having the web app poll backend sync state (and later, first `emailBatch`) and then flipping a user-level onboarding flag.

## Scope
- In:
  - Obsidian plugin: add glob configuration UI, local “what will sync” preview, and explicit “Sync now” UI/command.
  - Backend: ensure the plugin can authenticate and call the same scope/sync endpoints as the web app (Better Auth API keys), and expose onboarding progress (connected + first sync done + email batch readiness).
  - Frontend: simplify Obsidian onboarding page (no glob editing), show connection status + instructions, and add onboarding gating via a `user.showOnboarding` flag with a loading screen that resolves automatically.
  - Notion: align “Go to app” with a notion sync trigger + status polling (so both integrations behave similarly).
- Out:
  - Full “email batch generation” implementation (if missing today); we’ll only wire onboarding to it once it exists.
  - Real-time backend→plugin push (WebSocket). The flow relies on plugin actions and/or polling.

## Files (added, updated, deleted)
- Updated: `apps/obsidian-plugin/src/settings.ts`
- Updated: `apps/obsidian-plugin/src/main.ts`
- Updated: `apps/obsidian-plugin/src/syncer.ts`
- Updated: `apps/back/app.ts`
- Updated: `apps/back/routes/obsidian.ts`
- Updated: `apps/back/routes/notion.ts`
- Updated: `apps/back/integrations/ingest.ts`
- Updated: `apps/front/src/routes/(app)/onboarding/configure-obsidian.tsx`
- Updated: `apps/front/src/routes/(app)/onboarding/configure-notion.tsx`
- Updated: `apps/front/src/routes/(app)/onboarding/onboarding-loading.tsx`
- Updated: `apps/front/src/routes/(app)/onboarding/onboarding-loading-2.tsx`
- Updated: `apps/front/src/routes/(app)/route.tsx`
- Updated: `packages/db/src/schemas/auth.ts`
- Added: `packages/db/drizzle/*` (migration for `user.showOnboarding`) (path may vary depending on existing migration setup)

## Nomenclature
- `apiKey` / “token”: Better Auth API key with prefix `dbb_obsidian` (used by the plugin via `Authorization: Bearer <token>`).
- `vaultId`: stable identifier generated by the plugin and stored in `integration_connections.accountExternalId`.
- `glob` / “scope”: include/exclude pattern(s) stored in `integration_scope_items` with `scopeType = "obsidian_glob"`.
- “First sync done”: backend has received at least one Obsidian sync batch that resulted in any ingest activity (or documents exist).
- “Onboarding done”: user can be redirected away from `/onboarding/*` (eventually gated by first `emailBatch` readiness).

## UX
- Obsidian flow:
  - Web onboarding shows GitHub install link + “Generate token” (API key), then instructs user to paste it into Obsidian plugin settings.
  - In Obsidian plugin settings, user sets glob and sees a local preview of included/excluded files.
  - User clicks “Sync now” (button) or runs `DBB: Sync now` (command).
  - User returns to DBB web app; “Go to app” shows a loading screen until backend detects first sync (and later: first `emailBatch`).
- Notion flow:
  - User connects Notion, selects databases, hits “Go to app”.
  - Backend starts Notion sync; web app shows loading until first sync (and later: first `emailBatch`).

## Data flow & db updates
- Authentication:
  - Use Better Auth API key plugin (`enableSessionForAPIKeys: true`) so plugin requests get a valid `session`/`user` from `auth.api.getSession`.
  - Standardize on one token type for the plugin (the API key created in `configure-obsidian.tsx`).
- Obsidian scope:
  - Plugin writes `glob` to backend via the same route the web app uses (or a dedicated plugin-friendly wrapper), updating `integration_scope_items`.
  - Plugin can also read current `glob` from backend to stay in sync with web onboarding (if the user changes it there in the future).
- Onboarding state:
  - Add `user.showOnboarding` (default `true`), surfaced in the session via `inferAdditionalFields`.
  - Backend flips `showOnboarding = false` when “ready” criteria are met (configurable: first sync or first email batch).

## Action items
[ ] Align Obsidian plugin HTTP calls with the backend oRPC procedures (verify the correct `/rpc/...` procedure paths) and authenticate via Better Auth API keys (no separate “pluginToken”).
[ ] Add a `glob` field to Obsidian plugin settings UI and implement “sync scope” behavior: on change → persist locally → call backend scope setter → refresh scope → (optionally) trigger a full sync.
[ ] Add a local preview panel in the plugin settings showing a small list of matched/unmatched Markdown file paths (sample N includes/excludes) to make scope intent obvious before syncing.
[ ] Add an explicit “Sync now” button in the plugin settings (keep the command palette action) and ensure it uses the current scope + debounced batching without blocking the UI.
[ ] Update `apps/back/routes/obsidian.ts` to support plugin-driven scope updates cleanly (API key auth + vault association) and to expose a status payload sufficient for onboarding (connection + lastSeen + last sync time).
[ ] Define and implement a backend “onboarding status” procedure that returns per-integration readiness (Notion: last sync; Obsidian: last sync) and the “first email batch ready” signal when available.
[ ] Add `user.showOnboarding` to the DB schema + migration, wire it into auth sessions, and add route guards: redirect onboarding users to `/onboarding/*`, and redirect completed users away from onboarding routes to `/dash`.
[ ] Update `onboarding-loading*.tsx` to poll onboarding status and automatically advance to `onboarding-final` (and/or `/dash`) when readiness conditions are met.
[ ] Implement/outline Notion “sync now” trigger (called from “Go to app”) and include its progress in onboarding status so Notion and Obsidian share the same loading behavior.
[ ] Validate end-to-end with `bun type-check`, `bun --cwd apps/obsidian-plugin build`, and a manual smoke test: install plugin into a dev vault, set glob, run sync, and confirm the web UI transitions out of loading.

## Open questions
- What is the exact “ready” condition for ending onboarding right now: first successful sync, first non-empty documents set, or first `emailBatch` created?
- Should Obsidian scope be a single glob string (current UI) or multiple patterns (array) to match the plugin’s “patterns” model?
- Do we want multi-vault support per user during onboarding, or should we explicitly treat “latest active connection” as the only one?

